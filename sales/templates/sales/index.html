{% extends 'sales/layout.html' %}

{% block title %}MajiMóveis | Encontre o imóvel ideal{% endblock %}

{% block filter %}
  {% include 'sales/partials/filter_form.html' %}
{% endblock %}

{% block content %}
<div class="container">
  <!-- Modern Tab Navigation -->
  <div class="tab-container">
    <div class="tab-nav">
      <button class="tab-btn active" data-page="new">
        <i class="fas fa-home"></i>
        <span>Novos Imóveis</span>
      </button>
      <button class="tab-btn" data-page="liked">
        <i class="fas fa-heart"></i>
        <span>Favoritos</span>
      </button>
      <button class="tab-btn" data-page="disliked">
        <i class="fas fa-times-circle"></i>
        <span>Rejeitados</span>
      </button>
    </div>

    <!-- Tab Indicators -->
    <div class="tab-indicators">
      <div class="indicator new-indicator"></div>
      <div class="indicator liked-indicator"></div>
      <div class="indicator disliked-indicator"></div>
    </div>
  </div>

  <!-- Aba Novos -->
  <div id="new" class="property-tab active">
    <div class="tab-header">
      <h2>Novos Imóveis</h2>
      <p>Descubra as melhores oportunidades imobiliárias</p>
    </div>
    
    <div class="properties-grid" id="container-new">
      {% for property in imos %}
        {% include 'sales/partials/property_card.html' with property=property %}
      {% empty %}
        <div class="empty-state">
          <i class="fas fa-home"></i>
          <h3>Nenhum imóvel disponível</h3>
          <p>Novos imóveis serão adicionados em breve</p>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Aba Curtidos -->
  <div id="liked" class="property-tab">
    <div class="tab-header">
      <h2>Imóveis Favoritos</h2>
      <p>Suas propriedades selecionadas</p>
    </div>
    
    <div class="properties-grid" id="container-liked">
      {% for property in imos_liked %}
        {% include 'sales/partials/property_card.html' with property=property %}
      {% empty %}
        <div class="empty-state">
          <i class="fas fa-heart"></i>
          <h3>Nenhum favorito ainda</h3>
          <p>Clique no ícone de coração para salvar imóveis</p>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Aba Rejeitados -->
  <div id="disliked" class="property-tab">
    <div class="tab-header">
      <h2>Imóveis Rejeitados</h2>
      <p>Propriedades que não atendem seus critérios</p>
    </div>
    
    <div class="properties-grid" id="container-disliked">
      {% for property in imos_disliked %}
        {% include 'sales/partials/property_card.html' with property=property %}
      {% empty %}
        <div class="empty-state">
          <i class="fas fa-times-circle"></i>
          <h3>Nenhum imóvel rejeitado</h3>
          <p>Você ainda não rejeitou nenhuma propriedade</p>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Modal Fullscreen -->
<div id="fullscreen-modal" class="fullscreen-modal">
  <div class="modal-container">
    <span class="close">&times;</span>
    
    <div class="modal-nav">
      <button id="prev-image" class="nav-arrow">
        <i class="fas fa-chevron-left"></i>
      </button>
      
      <div id="modal-content" class="modal-content">
        <div class="image-loader">
          <div class="spinner"></div>
        </div>
      </div>
      
      <button id="next-image" class="nav-arrow">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
    
    <div class="image-counter">
      <span id="current-image">1</span> de <span id="total-images">0</span>
    </div>
  </div>
</div>

<style>
  /* Tab Navigation */
  .tab-container {
    margin: 25px 0 40px;
    position: relative;
  }
  
  .tab-nav {
    display: flex;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    overflow: hidden;
  }
  
  .tab-btn {
    flex: 1;
    padding: 16px 10px;
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    color: #6c757d;
    transition: all 0.3s ease;
    position: relative;
    z-index: 2;
  }
  
  .tab-btn i {
    font-size: 20px;
  }
  
  .tab-btn span {
    font-size: 14px;
  }
  
  .tab-btn.active {
    color: #1a6dcc;
  }
  
  .tab-indicators {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    display: flex;
  }
  
  .indicator {
    flex: 1;
    height: 100%;
    border-radius: 2px;
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
  }
  
  .new-indicator { background: #1a6dcc; }
  .liked-indicator { background: #2ecc71; }
  .disliked-indicator { background: #ff6b6b; }
  
  .tab-nav .tab-btn:nth-child(1).active ~ .tab-indicators .new-indicator {
    transform: scaleX(1);
  }
  
  .tab-nav .tab-btn:nth-child(2).active ~ .tab-indicators .liked-indicator {
    transform: scaleX(1);
  }
  
  .tab-nav .tab-btn:nth-child(3).active ~ .tab-indicators .disliked-indicator {
    transform: scaleX(1);
  }
  
  /* Tab Content */
  .property-tab {
    display: none;
  }
  
  .property-tab.active {
    display: block;
  }
  
  .tab-header {
    margin-bottom: 30px;
    text-align: center;
  }
  
  .tab-header h2 {
    font-size: 28px;
    margin-bottom: 8px;
    color: #2c3e50;
  }
  
  .tab-header p {
    color: #6c757d;
    font-size: 16px;
  }
  
  /* Properties Grid */
  .properties-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 30px;
    margin-bottom: 50px;
  }
  
  /* Empty State */
  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
  }
  
  .empty-state i {
    font-size: 60px;
    color: #e9ecef;
    margin-bottom: 20px;
  }
  
  .empty-state h3 {
    color: #2c3e50;
    margin-bottom: 10px;
  }
  
  .empty-state p {
    color: #6c757d;
    max-width: 400px;
    margin: 0 auto;
  }
  
  /* Fullscreen Modal Improvements */
  .fullscreen-modal {
    background-color: rgba(0, 0, 0, 0.95);
  }
  
  .modal-container {
    width: 95%;
    max-width: 1400px;
    height: 90%;
  }
  
  .modal-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    height: 100%;
  }
  
  .nav-arrow {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1001;
    transition: all 0.3s ease;
  }
  
  .nav-arrow:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
  }
  
  .modal-content {
    width: calc(100% - 160px);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  
  .modal-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }
  
  .close {
    top: 25px;
    right: 25px;
    font-size: 40px;
    color: rgba(255, 255, 255, 0.8);
    transition: color 0.3s ease;
  }
  
  .close:hover {
    color: white;
  }
  
  .image-counter {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.5);
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 14px;
    z-index: 1001;
  }
  
  .image-loader {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    z-index: 1;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  let imageUrls = [];
  let currentImageIndex = 0;
  let isModalOpen = false;

  // Run setup immediately because this script is placed after the HTML
  // content and the DOM is already loaded when it executes.
    /* --------- Alternar abas --------- */
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update content tabs
        document.querySelectorAll('.property-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(btn.dataset.page).classList.add('active');
      });
    });

    /* --------- Delegação de cliques --------- */
    document.body.addEventListener('click', e => {
      /* Curtir */
      const like = e.target.closest('.like-btn');
      if (like) {
        const id = like.dataset.id;
        fetch(`/like/${id}/`)
          .then(r => r.json())
          .then(data => {
            const target = data.liked ? 'liked' : 'new';
            moveCard(id, target);
          });
        return;
      }

      /* Rejeitar */
      const dislike = e.target.closest('.dislike-btn');
      if (dislike) {
        const id = dislike.dataset.id;
        fetch(`/dislike/${id}/`)
          .then(r => r.json())
          .then(data => {
            const target = data.disliked ? 'disliked' : 'new';
            moveCard(id, target);
          });
        return;
      }

      /* Detalhes */
      const details = e.target.closest('.details-btn');
      if (details) {
        const id = details.dataset.id;
        const sec = document.getElementById(`additional-info-${id}`);
        if (sec) {
          const isHidden = sec.classList.toggle('hidden');
          const iconClass = isHidden ? 'fa-info-circle' : 'fa-times';
          const btnText = isHidden ? 'Detalhes' : 'Fechar';
          details.innerHTML = `<i class="fas ${iconClass} me-1"></i> ${btnText}`;
        }
        return;
      }

      /* Contato */
      const contact = e.target.closest('.contact-agent-btn');
      if (contact) {
        const propertyId = contact.dataset.propertyId;
        alert(`Contato solicitado para o imóvel ID: ${propertyId}\nUm corretor entrará em contato em breve.`);
        return;
      }

      /* Thumbnail → abre modal */
      const thumb = e.target.closest('.property-thumbnail');
      if (thumb) {
        openFullscreen(thumb);
        return;
      }
    });

    /* --------- Controles do modal --------- */
    document.getElementById('prev-image').addEventListener('click', e => {
      e.stopPropagation();
      showImage(currentImageIndex - 1);
    });

    document.getElementById('next-image').addEventListener('click', e => {
      e.stopPropagation();
      showImage(currentImageIndex + 1);
    });

    document.querySelector('#fullscreen-modal .close')
            .addEventListener('click', e => {
              e.stopPropagation();
              closeFullscreen();
            });

    document.addEventListener('keydown', e => {
      if (!isModalOpen) return;

      if (e.key === 'Escape') {
        closeFullscreen();
      } else if (e.key === 'ArrowLeft') {
        showImage(currentImageIndex - 1);
      } else if (e.key === 'ArrowRight') {
        showImage(currentImageIndex + 1);
      }
    });

  /* ---------- helpers ---------- */
  function moveCard(id, target) {
    const card = document.getElementById(`property-${id}`);
    if (!card) return;
    card.remove();
    document.getElementById(`container-${target}`).prepend(card);
  }

  function openFullscreen(thumb) {
    imageUrls = JSON.parse(thumb.dataset.images);
    if (!imageUrls || !imageUrls.length) return;

    currentImageIndex = 0;
    showImage(0);

    const modal = document.getElementById('fullscreen-modal');
    modal.classList.add('active');
    isModalOpen = true;

    // Update image counter
    document.getElementById('total-images').textContent = imageUrls.length;
    document.getElementById('current-image').textContent = currentImageIndex + 1;

    // Prevent scrolling on body when modal is open
    document.body.style.overflow = 'hidden';
  }

  function showImage(i) {
    if (!imageUrls.length) return;

    // Handle wrap-around
    if (i < 0) i = imageUrls.length - 1;
    if (i >= imageUrls.length) i = 0;

    currentImageIndex = i;
    const mc = document.getElementById('modal-content');
    
    // Show loader
    mc.innerHTML = '<div class="image-loader"><div class="spinner"></div></div>';

    // Update image counter
    document.getElementById('current-image').textContent = currentImageIndex + 1;

    // Create new image element
    const img = new Image();
    img.src = imageUrls[currentImageIndex];
    img.alt = "Imagem do imóvel";
    img.onload = () => {
      mc.innerHTML = '';
      mc.appendChild(img);
    };
    
    img.onerror = () => {
      mc.innerHTML = '<div class="image-error">Falha ao carregar imagem</div>';
    };
  }

  function closeFullscreen() {
    const modal = document.getElementById('fullscreen-modal');
    modal.classList.remove('active');
    isModalOpen = false;

    // Restore body scrolling
    document.body.style.overflow = '';

    // Small delay before clearing to allow animation to finish
    setTimeout(() => {
      imageUrls = [];
      currentImageIndex = 0;
      document.getElementById('modal-content').innerHTML = '';
    }, 300);
  }
</script>

{% endblock %}