{% extends 'sales/layout.html' %}

{% block title %}MajiMÃ³veis | Encontre o imÃ³vel ideal{% endblock %}

{% block filter %}
  {% include 'sales/partials/filter_form.html' %}
{% endblock %}

{% block content %}
<div class="container">
  <!-- NavegaÃ§Ã£o por abas -->
  <div class="text-center my-4">
    <button class="btn btn-outline-secondary mx-2" data-page="disliked">ğŸ‘ Rejeitados</button>
    <button class="btn btn-outline-primary  mx-2" data-page="new">ğŸ†• Novos</button>
    <button class="btn btn-outline-success  mx-2" data-page="liked">ğŸ‘ Curtidos</button>
  </div>

  <!-- Aba Rejeitados -->
  <div id="disliked" class="property-tab hidden">
    <h4 class="mb-3">ğŸ‘ ImÃ³veis Rejeitados</h4>
    <div class="properties-container" id="container-disliked">
      {% for property in imos_disliked %}
        {% include 'sales/partials/property_card.html' with property=property %}
      {% empty %}
        <p class="text-muted">VocÃª ainda nÃ£o rejeitou nenhum imÃ³vel.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Aba Novos -->
  <div id="new" class="property-tab">
    <h4 class="mb-3">ğŸ†• Novos ImÃ³veis</h4>
    <div class="properties-container" id="container-new">
      {% for property in imos %}
        {% include 'sales/partials/property_card.html' with property=property %}
      {% empty %}
        <p class="text-muted">Nenhum imÃ³vel disponÃ­vel no momento.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Aba Curtidos -->
  <div id="liked" class="property-tab hidden">
    <h4 class="mb-3">ğŸ‘ ImÃ³veis Curtidos</h4>
    <div class="properties-container" id="container-liked">
      {% for property in imos_liked %}
        {% include 'sales/partials/property_card.html' with property=property %}
      {% empty %}
        <p class="text-muted">VocÃª ainda nÃ£o curtiu nenhum imÃ³vel.</p>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Modal Fullscreen -->
<div id="fullscreen-modal" class="fullscreen-modal hidden">
  <span class="close">&times;</span>
  <button id="prev-image" class="nav-arrow">&#10094;</button>
  <div id="modal-content" class="modal-content"></div>
  <button id="next-image" class="nav-arrow">&#10095;</button>
</div>

<script>
  let imageUrls = [];
  let currentImageIndex = 0;

  document.addEventListener('DOMContentLoaded', () => {

    /* --------- Alternar abas --------- */
    document.querySelectorAll('button[data-page]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.property-tab').forEach(t => t.classList.add('hidden'));
        document.getElementById(btn.dataset.page).classList.remove('hidden');
      });
    });

/* --------- DelegaÃ§Ã£o de cliques --------- */
document.body.addEventListener('click', e => {

/* Thumbnail â†’ abre modal  (primeiro!) */
const thumb = e.target.closest('.property-thumbnail');
if (thumb) {
  imageUrls = JSON.parse(thumb.dataset.images);
  currentImageIndex = 0;
  showImage(0);
  const modal = document.getElementById('fullscreen-modal');
  modal.classList.add('active');
  modal.classList.remove('hidden');
  return;   // sai depois de abrir modal
}

/* Curtir */
const like = e.target.closest('.like-btn');
if (like) {
  const id = like.dataset.id;
  fetch(`/like/${id}/`).then(() => moveCard(id, 'liked'));
  return;
}

/* Rejeitar */
const dislike = e.target.closest('.dislike-btn');
if (dislike) {
  const id = dislike.dataset.id;
  fetch(`/dislike/${id}/`).then(() => moveCard(id, 'disliked'));
  return;
}

/* Detalhes  */
const details = e.target.closest('.details-btn');
if (details) {
  const id = details.dataset.id;
  const sec = document.getElementById(`additional-info-${id}`);
  sec && sec.classList.toggle('hidden');
  return;
}

/* Fecha modal clicando no fundo escuro */
if (e.target.id === 'fullscreen-modal') {
  closeFullscreen();
}
});


      /* Thumbnail â†’ abre modal */
      const thumb = e.target.closest('.property-thumbnail');
      if (thumb) {
        imageUrls = JSON.parse(thumb.dataset.images);
        currentImageIndex = 0;
        showImage(0);
        document.getElementById('fullscreen-modal').classList.add('active');
        document.getElementById('fullscreen-modal').classList.remove('hidden');
        return;
      }

      /* Fecha modal clicando no fundo */
      if (e.target.id === 'fullscreen-modal') closeFullscreen();
    });

    /* --------- Controles do modal --------- */
    document.getElementById('prev-image').addEventListener('click', e => {
      e.stopPropagation();
      showImage(currentImageIndex - 1);
    });

    document.getElementById('next-image').addEventListener('click', e => {
      e.stopPropagation();
      showImage(currentImageIndex + 1);
    });

    document.querySelector('#fullscreen-modal .close')
            .addEventListener('click', e => { e.stopPropagation(); closeFullscreen(); });

    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeFullscreen(); });
  });

  /* ---------- helpers ---------- */
  function moveCard(id, target) {
    const card = document.getElementById(`property-${id}`);
    if (!card) return;
    card.remove();
    document.getElementById(`container-${target}`).prepend(card);
  }

  function showImage(i) {
    if (!imageUrls.length) return;
    if (i < 0) i = imageUrls.length - 1;
    if (i >= imageUrls.length) i = 0;
    currentImageIndex = i;

    const mc = document.getElementById('modal-content');
    mc.innerHTML = `<img src="${imageUrls[currentImageIndex]}" />`;
  }

  function closeFullscreen() {
    const m = document.getElementById('fullscreen-modal');
    m.classList.add('hidden');
    m.classList.remove('active');
    imageUrls = [];
    currentImageIndex = 0;
    document.getElementById('modal-content').innerHTML = '';
  }
  </script>

{% endblock %}
