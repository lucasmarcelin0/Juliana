{% block filter %}
<!-- Filter Form Container -->
<div id="filter-form-container" class="filter-form-container hidden">
    <div class="filter-form-content">
        <form id="filter-form" class="filter-form" method="GET" action="{% url 'sales:filter_properties' %}">
            <div class="filter-column">
                <!-- Price and Location -->
                <div class="filter-section">
                    <h3 class="section-title">Pre√ßo e Localiza√ß√£o</h3>
                    <div class="filter-field">
                        <label for="min_price">Pre√ßo M√≠nimo (R$)</label>
                        <input type="number" id="min_price" name="min_price" placeholder="Ex: 200000">
                    </div>
                    <div class="filter-field">
                        <label for="max_price">Pre√ßo M√°ximo (R$)</label>
                        <input type="number" id="max_price" name="max_price" placeholder="Ex: 500000">
                    </div>
                    <div class="filter-field">
                        <label for="location">Localiza√ß√£o</label>
                        <input type="text" id="location" name="location" placeholder="Cidade ou Bairro">
                    </div>
                </div>

                <!-- Property Type and Size -->
                <div class="filter-section">
                    <h3 class="section-title">Tipo e Tamanho</h3>
                    <div class="filter-field">
                        <label for="property_type">Tipo de Im√≥vel</label>
                        <select id="property_type" name="property_type">
                            <option value="">Todos</option>
                            <option value="apartment">Apartamento</option>
                            <option value="house">Casa</option>
                            <option value="land">Lote</option>
                            <option value="farm">Fazenda</option>
                            <option value="warehouse">Galp√£o</option>
                            <option value="commercial">Comercial</option>
                        </select>
                    </div>
                    <div class="filter-field">
                        <label for="property_area_min">√Årea √∫til m√≠nima (m¬≤)</label>
                        <input type="number" id="property_area_min" name="property_area_min" placeholder="Ex: 50">
                    </div>
                    <div class="filter-field">
                        <label for="property_area_max">√Årea √∫til m√°xima (m¬≤)</label>
                        <input type="number" id="property_area_max" name="property_area_max" placeholder="Ex: 200">
                    </div>
                    <div class="filter-field">
                        <label for="private_area_min">√Årea privativa m√≠nima (m¬≤)</label>
                        <input type="number" id="private_area_min" name="private_area_min" placeholder="Ex: 40">
                    </div>
                    <div class="filter-field">
                        <label for="private_area_max">√Årea privativa m√°xima (m¬≤)</label>
                        <input type="number" id="private_area_max" name="private_area_max" placeholder="Ex: 180">
                    </div>
                </div>
            </div>

            <div class="filter-column">
                <!-- Rooms and Features -->
                <div class="filter-section">
                    <h3 class="section-title">C√¥modos</h3>
                    <div class="filter-field">
                        <label for="bedrooms">Dormit√≥rios</label>
                        <input type="number" id="bedrooms" name="bedrooms" placeholder="Ex: 2">
                    </div>
                    <div class="filter-field">
                        <label for="suites">Su√≠tes</label>
                        <input type="number" id="suites" name="suites" placeholder="Ex: 1">
                    </div>
                    <div class="filter-field">
                        <label for="bathrooms">Banheiros</label>
                        <input type="number" id="bathrooms" name="bathrooms" placeholder="Ex: 2">
                    </div>
                    <div class="filter-field">
                        <label for="garage_spots">Vagas</label>
                        <input type="number" id="garage_spots" name="garage_spots" placeholder="Ex: 1">
                    </div>
                </div>

                <!-- Amenities -->
                <div class="filter-section">
                    <h3 class="section-title">Caracter√≠sticas</h3>
                    <div class="filter-field">
                        <label for="features">Adere√ßos</label>
                        <input type="text" id="features" name="features" placeholder="piscina, jardim">
                    </div>
                    <div class="filter-field">
                        <label for="is_covered">Cobertura</label>
                        <select id="is_covered" name="is_covered">
                            <option value="">Todos</option>
                            <option value="yes">Sim</option>
                            <option value="no">N√£o</option>
                        </select>
                    </div>
                    <div class="filter-field">
                        <label for="garage_type">Tipo de Vaga</label>
                        <select id="garage_type" name="garage_type">
                            <option value="">Todos</option>
                            <option value="covered">Coberta</option>
                            <option value="free">Livre</option>
                            <option value="covered_and_free">Coberta e Livre</option>
                            <option value="none">Sem vaga</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="filter-column">
                <!-- Additional Features -->
                <div class="filter-section">
                    <h3 class="section-title">Outras Caracter√≠sticas</h3>
                    <div class="filter-field">
                        <label for="has_pool">Piscina</label>
                        <select id="has_pool" name="has_pool">
                            <option value="">Todos</option>
                            <option value="yes">Sim</option>
                            <option value="no">N√£o</option>
                        </select>
                    </div>
                    <div class="filter-field">
                        <label for="has_gatehouse">Portaria</label>
                        <select id="has_gatehouse" name="has_gatehouse">
                            <option value="">Todos</option>
                            <option value="24h">24 h</option>
                            <option value="daytime">Diurna</option>
                            <option value="night">Noturna</option>
                            <option value="none">Sem portaria</option>
                        </select>
                    </div>
                    <div class="filter-field">
                        <label for="is_occupied">Ocupa√ß√£o</label>
                        <select id="is_occupied" name="is_occupied">
                            <option value="">Todos</option>
                            <option value="vacant">Vago</option>
                            <option value="owner">Propriet√°rio</option>
                            <option value="tenant">Inquilino</option>
                        </select>
                    </div>
                    <div class="filter-field">
                        <label for="accessibility">Acessibilidade</label>
                        <select id="accessibility" name="accessibility">
                            <option value="">Todos</option>
                            <option value="yes">Sim</option>
                            <option value="no">N√£o</option>
                        </select>
                    </div>
                </div>

                <!-- Financial Info -->
                <div class="filter-section">
                    <h3 class="section-title">Valores</h3>
                    <div class="filter-field">
                        <label for="min_sale_price">Venda m√≠nima (R$)</label>
                        <input type="number" id="min_sale_price" name="min_sale_price" placeholder="Ex: 250000">
                    </div>
                    <div class="filter-field">
                        <label for="max_sale_price">Venda m√°xima (R$)</label>
                        <input type="number" id="max_sale_price" name="max_sale_price" placeholder="Ex: 600000">
                    </div>
                    <div class="filter-field">
                        <label for="min_condo_fee">Condom√≠nio m√≠nimo (R$)</label>
                        <input type="number" id="min_condo_fee" name="min_condo_fee" placeholder="Ex: 300">
                    </div>
                    <div class="filter-field">
                        <label for="max_condo_fee">Condom√≠nio m√°ximo (R$)</label>
                        <input type="number" id="max_condo_fee" name="max_condo_fee" placeholder="Ex: 1000">
                    </div>
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit" id="apply-filters" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Aplicar Filtros
                </button>
                <button type="button" id="reset-filters" class="btn btn-secondary">
                    <i class="fas fa-undo"></i> Limpar Filtros
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.filter-form-container {
    background: #ffffff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.filter-form-content {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
}

.filter-column {
    flex: 1;
    min-width: 250px;
}

.filter-section {
    margin-bottom: 25px;
}

.section-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
    padding-bottom: 5px;
    border-bottom: 1px solid #eee;
}

.filter-field {
    margin-bottom: 15px;
}

.filter-field label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #555;
}

.filter-field input,
.filter-field select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.filter-field input:focus,
.filter-field select:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
}

.filter-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #eee;
    flex-basis: 100%;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.btn i {
    font-size: 14px;
}

@media (max-width: 768px) {
    .filter-column {
        min-width: 100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filter-form');

    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            applyFilters();
        });

        const resetBtn = document.getElementById('reset-filters');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                filterForm.reset();
                applyFilters();
            });
        }
    }
});

function applyFilters() {
    const filterForm = document.getElementById('filter-form');
    const formData = new FormData(filterForm);
    const searchParams = new URLSearchParams();

    // Build query string
    for (const [key, value] of formData.entries()) {
        if (value) {
            searchParams.append(key, value);
        }
    }

    // Show loading state
    const activeTab = document.querySelector('.property-tab:not(.hidden)');
    const container = activeTab.querySelector('.properties-container');
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';

    // Make AJAX request
    fetch(`${filterForm.action}?${searchParams.toString()}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        updatePropertyCards(data.properties, container.id);
    })
    .catch(error => {
        console.error('Error:', error);
        container.innerHTML = '<p class="text-danger">Ocorreu um erro ao carregar os im√≥veis.</p>';
    });
}

function updatePropertyCards(properties, containerId) {
    const container = document.getElementById(containerId);

    if (!properties || properties.length === 0) {
        container.innerHTML = '<p class="text-muted">Nenhum im√≥vel encontrado com esses filtros.</p>';
        return;
    }

    // Clear container
    container.innerHTML = '';

    // Create HTML for each property
    properties.forEach(property => {
        const cardHtml = `
            <div class="property-card" id="property-${property.id}">
                <div class="property-thumbnail" data-images='${JSON.stringify(property.images.map(img => img.url))}'>
                    ${property.images.length > 0 ?
                        `<img src="${property.images[0].url}" alt="${property.street}">` :
                        '<div class="no-image">Sem imagem</div>'}
                </div>
                <div class="property-details">
                    <h3>${property.street}, ${property.street_number}</h3>
                    <p>${property.neighborhood}, ${property.city}</p>
                    <div class="property-features">
                        <span>${property.bedrooms} üõèÔ∏è</span>
                        <span>${property.bathrooms} üöø</span>
                        <span>${property.garage_spots} üöó</span>
                    </div>
                    <div class="property-prices">
                        <strong>R$ ${property.sale_price || '0,00'}</strong>
                    </div>
                    <div class="property-actions">
                        <button class="btn btn-outline-danger dislike-btn" data-id="${property.id}">üëé</button>
                        <button class="btn btn-outline-primary details-btn" data-id="${property.id}">Detalhes</button>
                        <button class="btn btn-outline-success like-btn" data-id="${property.id}">üëç</button>
                    </div>
                    <div id="additional-info-${property.id}" class="additional-info hidden">
                        <!-- Additional details here -->
                    </div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', cardHtml);
    });

    // Reattach event listeners to new cards
    attachCardEventListeners();
}

function attachCardEventListeners() {
    // Like button
    document.body.addEventListener('click', e => {
        const like = e.target.closest('.like-btn');
        if (like) {
            const id = like.dataset.id;
            fetch(`/like/${id}/`).then(() => moveCard(id, 'liked'));
            return;
        }

        // Dislike button
        const dislike = e.target.closest('.dislike-btn');
        if (dislike) {
            const id = dislike.dataset.id;
            fetch(`/dislike/${id}/`).then(() => moveCard(id, 'disliked'));
            return;
        }

        // Details button
        const details = e.target.closest('.details-btn');
        if (details) {
            const id = details.dataset.id;
            const sec = document.getElementById(`additional-info-${id}`);
            if (sec) sec.classList.toggle('hidden');
            return;
        }

        // Thumbnail click (for image carousel)
        const thumb = e.target.closest('.property-thumbnail');
        if (thumb) {
            // Your existing image carousel code here
            return;
        }
    });
}

function moveCard(id, target) {
    const card = document.getElementById(`property-${id}`);
    if (!card) return;
    card.remove();
    document.getElementById(`container-${target}`).prepend(card);
}
</script>
{% endblock %}
