<div class="property-card shadow-sm rounded-4 border bg-white p-3 mb-4">

  <!-- M√≠dia do im√≥vel -->
  <div class="property-media row g-3 mb-3">

    <!-- Imagem principal -->
    <div class="col-md-6">
      {% if property.images.first %}
        <img src="{{ property.images.first.image.url }}"
             alt="Imagem do Im√≥vel"
             class="img-fluid rounded shadow-sm w-100"
             style="cursor:pointer"
             onclick="openGallery({{ property.id }})">
      {% endif %}
    </div>

    <!-- V√≠deo -->
    <div class="col-md-6">
      {% if property.video_url %}
        <div class="ratio ratio-16x9">
          <iframe src="{{ property.video_url }}"
                  allowfullscreen
                  class="rounded border w-100"></iframe>
        </div>
      {% endif %}
    </div>

    <!-- Galeria Modal Oculta -->
    <div id="gallery-modal-{{ property.id }}" class="gallery-modal d-none">
      <div class="gallery-backdrop" onclick="closeGallery({{ property.id }})"></div>
      <div class="gallery-content">
        <span class="gallery-close" onclick="closeGallery({{ property.id }})">&times;</span>
        {% for image in property.images.all %}
          <img src="{{ image.image.url }}" class="gallery-image mb-2">
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Informa√ß√µes principais -->
  <div class="property-info mb-3">
    <p class="mb-1"><i class="fas fa-map-marker-alt text-primary"></i>
      <strong>{{ property.street }}, {{ property.street_number }}</strong> - {{ property.neighborhood }}, {{ property.city }} - {{ property.state }}
    </p>
    <p class="mb-1"><i class="fas fa-coins text-success"></i>
      <strong>R$ {{ property.sale_price|default:property.rent_price }}</strong>
      {% if property.sale_price %}
        <span class="badge bg-success ms-2">Venda</span>
      {% else %}
        <span class="badge bg-primary ms-2">Aluguel</span>
      {% endif %}
    </p>
  </div>

  <!-- A√ß√µes -->
  <div class="d-flex justify-content-start gap-2 mb-3">
    <button class="btn btn-outline-success btn-sm like-btn" data-id="{{ property.id }}">üëç Curtir</button>
    <button class="btn btn-outline-danger btn-sm dislike-btn" data-id="{{ property.id }}">üëé Rejeitar</button>
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleDetails({{ property.id }})">üìÑ Detalhes</button>
  </div>

  <!-- Detalhes ocultos -->
  <div id="additional-info-{{ property.id }}" class="property-info hidden mt-3 border-top pt-3 small">
    <div class="row">
      <div class="col-md-4"><strong>√Årea do Im√≥vel:</strong> {{ property.property_area }} m¬≤</div>
      <div class="col-md-4"><strong>Quartos:</strong> {{ property.bedrooms }}</div>
      <div class="col-md-4"><strong>Su√≠tes:</strong> {{ property.suites }}</div>
      <div class="col-md-4"><strong>Banheiros:</strong> {{ property.bathrooms }}</div>
      <div class="col-md-4"><strong>Garagem:</strong> {{ property.garage_spots }} vaga(s)</div>
      <div class="col-md-4"><strong>Tipo de Vaga:</strong> {{ property.get_garage_type_display }}</div>
      <div class="col-md-4"><strong>Piscina:</strong> {{ property.has_pool }}</div>
      <div class="col-md-4"><strong>Portaria:</strong> {{ property.get_has_gatehouse_display }}</div>
      <div class="col-md-4"><strong>Condi√ß√£o:</strong> {{ property.get_is_occupied_display }}</div>
      <div class="col-md-6"><strong>Acessibilidade:</strong> {{ property.accessibility }}</div>
      <div class="col-md-6"><strong>Disponibilidade:</strong> {{ property.move_availability }}</div>
      <div class="col-md-6"><strong>IPTU:</strong> R$ {{ property.iptu_value }}</div>
      <div class="col-md-6"><strong>Condom√≠nio:</strong> R$ {{ property.condo_fee }}</div>
      <div class="col-12"><strong>Caracter√≠sticas:</strong> {{ property.features }}</div>
      <div class="col-12"><strong>Descri√ß√£o:</strong> {{ property.free_description }}</div>
    </div>

    <div class="mt-3">
      {% include 'sales/partials/bids_section.html' with property=property %}
    </div>
  </div>

  <!-- CSS embutido -->
  <style>
    .gallery-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      padding: 2rem;
      overflow-y: auto;
    }

    .gallery-backdrop {
      position: absolute;
      width: 100%;
      height: 100%;
      background: transparent;
      top: 0;
      left: 0;
      z-index: 1;
    }

    .gallery-content {
      z-index: 2;
      max-width: 90%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .gallery-image {
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 0 10px #000;
    }

    .gallery-close {
      font-size: 2rem;
      color: white;
      cursor: pointer;
      align-self: flex-end;
      margin-bottom: 1rem;
    }
  </style>

  <!-- JS embutido -->
  <script>
    function openGallery(id) {
      const modal = document.getElementById(`gallery-modal-${id}`);
      if (modal) modal.classList.remove("d-none");
    }

    function closeGallery(id) {
      const modal = document.getElementById(`gallery-modal-${id}`);
      if (modal) modal.classList.add("d-none");
    }

    function toggleDetails(id) {
      const section = document.getElementById(`additional-info-${id}`);
      if (section) {
        section.classList.toggle("hidden");
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.addEventListener("click", function () {
          const propertyId = this.dataset.id;
          fetch(`/like/${propertyId}/`)
            .then(r => r.json())
            .then(data => {
              this.classList.toggle("btn-success", data.liked);
              this.classList.toggle("btn-outline-success", !data.liked);

              const dislikeBtn = document.querySelector(`.dislike-btn[data-id="${propertyId}"]`);
              if (dislikeBtn) {
                dislikeBtn.classList.remove("btn-danger");
                dislikeBtn.classList.add("btn-outline-danger");
              }
            });
        });
      });

      document.querySelectorAll('.dislike-btn').forEach(btn => {
        btn.addEventListener("click", function () {
          const propertyId = this.dataset.id;
          fetch(`/dislike/${propertyId}/`)
            .then(r => r.json())
            .then(data => {
              this.classList.toggle("btn-danger", data.disliked);
              this.classList.toggle("btn-outline-danger", !data.disliked);

              const likeBtn = document.querySelector(`.like-btn[data-id="${propertyId}"]`);
              if (likeBtn) {
                likeBtn.classList.remove("btn-success");
                likeBtn.classList.add("btn-outline-success");
              }
            });
        });
      });
    });
  </script>
</div>
